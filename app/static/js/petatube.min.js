(function(){"use strict";window.PetaTube={Model:{},Collection:{},View:{}},jQuery(function(){var t=window.PetaTube,e=new t.Collection.Videos;new t.View.Search({videos:e}),new t.View.Video({videos:e});var i=window.location.search.match(/\?(https?.+)/);if(i){var n=i[1];e.fetchByUrl(n)}else{var o=new t.Collection.HotPages;new t.View.HotPages({collection:o}),o.fetch()}$(".bookmarklet").powerTip({placement:"s"})})})(),function(){"use strict";PetaTube.Model.HotPage=Backbone.Model.extend({petaURL:function(){return"/?"+this.get("url")},thumbnailImagePath:function(){return"http://i.ytimg.com/vi/"+this.get("thumbnailVideoId")+"/default.jpg"}})}(),function(){"use strict";PetaTube.Model.Video=Backbone.Model.extend({urlRoot:"/api/video"})}(),function(){"use strict";PetaTube.Collection.HotPages=Backbone.Collection.extend({model:PetaTube.Model.HotPage,fetch:function(){$.ajax({url:"/api/hot",dataType:"json",data:{}}).done($.proxy(function(t){this.reset(t)},this))}})}(),function(){"use strict";PetaTube.Collection.Videos=Backbone.Collection.extend({currentIndex:0,model:PetaTube.Model.Video,fetchByUrl:function(t){$.ajax({url:"/api/page",dataType:"json",data:{url:t}}).done($.proxy(function(t){this.currentIndex=0,this.title=t.title,this.url=t.url,this.reset(t.video_ids),this.trigger("change:title")},this))},current:function(){return this.at(this.currentIndex)},next:function(){++this.currentIndex,this.currentIndex>=this.length&&(this.currentIndex=0)},prev:function(){--this.currentIndex,0>this.currentIndex&&(this.currentIndex=this.length-1)},skip:function(){var t=this.current().id;this.next(),this.remove(t),0!==this.currentIndex&&this.prev()},shufflePlay:function(){this.currentIndex=0,this.reset(this.shuffle())}})}(),function(){"use strict";PetaTube.View.HotPages=Backbone.View.extend({el:"#hot",initialize:function(){this.collection.on("reset",this.draw,this)},draw:function(t){var e=$("<ul>");t.each(function(t){var i=$("#tmpl-hot-pages").html(),n=_.template(i,{title:t.get("title"),petaURL:t.petaURL(),videoCount:t.get("videoCount"),thumbnailImagePath:t.thumbnailImagePath()});e.append(n)}),this.$el.append(e),this.$el.fadeIn()}})}(),function(){"use strict";PetaTube.View.Search=Backbone.View.extend({el:"#input-url",initialize:function(t){this.videos=t.videos,this.videos.on("change:title",this.showTitle,this)},events:{"submit form":"search"},search:function(){var t=this.$el.find("input[name='url']").val();return t&&(window.location.search=t),!1},showTitle:function(){this.$el.find("#play-url").empty().append($("<span>").text("by ")).append($("<a>").attr("href",this.videos.url).text(this.videos.title)).append($('<span class="video_count">').text("("+this.videos.length+"videos)"))}})}(),function(){"use strict";PetaTube.View.Video=Backbone.View.extend({player:null,el:"#play-video",initialize:function(t){this.videos=t.videos,this.videos.on("reset",this.play,this)},events:{"click #prev-button":"prev","click #next-button":"next","click #shuffle-button":"shuffle"},next:function(){this.videos.next(),this.play()},prev:function(){this.videos.prev(),this.play()},skip:function(){this.videos.skip(),this.play()},shuffle:function(){this.videos.shufflePlay()},play:function(){var t=this.videos.current();t.get("title")?(this.$el.find("#video-info").text(t.get("title")),$("title").text(t.get("title")+"(PetaTube)")):t.fetch({success:$.proxy(function(){this.$el.find("#video-info").text(t.get("title")),$("title").text(t.get("title")+"(PetaTube)")},this)}),this.loadPlayer();var e=$("#tmpl-button").html(),i=_.template(e,{current:this.videos.currentIndex+1,total:this.videos.length});this.$el.find("#video-panel").html(i),this.$el.show()},loadPlayer:function(){var t=this.videos.current();if(this.player)return this.player.loadVideoById(t.id);var e=document.createElement("script");e.src="//www.youtube.com/iframe_api";var i=document.getElementsByTagName("script")[0];i.parentNode.insertBefore(e,i),window.onYouTubeIframeAPIReady=$.proxy(function(){this.player=new YT.Player("video",{height:"425",width:"760",videoId:t.id,events:{onReady:function(){},onStateChange:$.proxy(function(t){var e=t.data;e===YT.PlayerState.ENDED&&this.next()},this),onError:$.proxy(function(){this.skip()},this)}})},this)}})}();